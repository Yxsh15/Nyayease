{% extends "base.html" %}

{% block title %}My Documents - NyayEase{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800">My Uploaded Documents</h1>
        <button id="uploadDocumentButton" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
            Upload New Document
        </button>
    </div>

    <div id="documentsListContainer">
        <div class="text-center py-16 border-2 border-dashed border-gray-300 rounded-xl">
            <p class="text-2xl text-gray-500">Loading documents...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const documentsListContainer = document.getElementById('documentsListContainer');

    // Make fetchDocuments globally available for upload functionality
    window.fetchDocuments = async function() {
        documentsListContainer.innerHTML = `
            <div class="text-center py-16 border-2 border-dashed border-gray-300 rounded-xl">
                <p class="text-2xl text-gray-500">Loading documents...</p>
            </div>
        `;
        
        const token = localStorage.getItem('access_token');

        if (!token) {
            documentsListContainer.innerHTML = `
                <div class="text-center py-16 border-2 border-dashed border-gray-300 rounded-xl">
                    <p class="text-2xl text-gray-500">Please log in to view your documents.</p>
                    <p class="text-gray-400 mt-2">Click the "Login" button in the navigation bar.</p>
                </div>
            `;
            return;
        }

        try {
            const res = await fetch('/api/v1/documents/list', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (res.ok) {
                const documents = await res.json();
                if (documents.length > 0) {
                    let documentsHtml = `
                        <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                            <ul class="divide-y divide-gray-200">
                    `;
                    documents.forEach(doc => {
                        const uploadDate = new Date(doc.upload_date);
                        const formattedDate = uploadDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        documentsHtml += `
                            <li class="p-6 hover:bg-gray-50 transition" data-document-id="${doc.id}">
                                <div class="flex justify-between items-center">
                                    <div class="cursor-pointer flex-1" onclick="openDocumentDetails('${doc.id}')">
                                        <p class="text-lg font-semibold text-indigo-700">${doc.filename}</p>
                                        <p class="text-sm text-gray-500">Uploaded on: ${formattedDate}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button onclick="openDocumentDetails('${doc.id}')" class="text-indigo-600 hover:text-indigo-800 px-3 py-1 rounded text-sm border border-indigo-600 hover:bg-indigo-50">
                                            View
                                        </button>
                                        <button onclick="deleteDocument('${doc.id}', '${doc.filename}')" class="text-red-600 hover:text-red-800 px-3 py-1 rounded text-sm border border-red-600 hover:bg-red-50">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </li>
                        `;
                    });
                    documentsHtml += `
                            </ul>
                        </div>
                    `;
                    documentsListContainer.innerHTML = documentsHtml;
                } else {
                    documentsListContainer.innerHTML = `
                        <div class="text-center py-16 border-2 border-dashed border-gray-300 rounded-xl">
                            <p class="text-2xl text-gray-500">You haven't uploaded any documents yet.</p>
                            <p class="text-gray-400 mt-2">Click the "Upload New Document" button above to get started.</p>
                        </div>
                    `;
                }
            } else if (res.status === 401) {
                // Token invalid, refresh auth state
                await window.authUtils.verifyToken();
                documentsListContainer.innerHTML = `
                    <div class="text-center py-16 border-2 border-dashed border-gray-300 rounded-xl">
                        <p class="text-2xl text-gray-500">Your session has expired or you are not logged in.</p>
                        <p class="text-gray-400 mt-2">Please log in again to view your documents.</p>
                    </div>
                `;
            } else {
                const errorData = await res.json();
                documentsListContainer.innerHTML = `
                    <div class="text-center py-16 border-2 border-dashed border-gray-300 rounded-xl text-red-600">
                        <p class="text-2xl">Error loading documents: ${errorData.detail || 'Unknown error'}</p>
                    </div>
                `;
            }
        } catch (err) {
            documentsListContainer.innerHTML = `
                <div class="text-center py-16 border-2 border-dashed border-gray-300 rounded-xl text-red-600">
                    <p class="text-2xl">Could not connect to the server to load documents.</p>
                </div>
            `;
            console.error('Error fetching documents:', err);
        }
    };

    // Initial load
    await fetchDocuments();

    // Upload Document Button
    const uploadDocumentButton = document.getElementById('uploadDocumentButton');
    if (uploadDocumentButton) {
        uploadDocumentButton.addEventListener('click', () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Please log in first to upload documents.');
                return;
            }
            
            const uploadModal = document.getElementById('uploadModal');
            if (uploadModal) {
                uploadModal.classList.remove('hidden');
                uploadModal.classList.add('flex');
                const uploadError = document.getElementById('uploadError');
                const uploadSuccess = document.getElementById('uploadSuccess');
                if (uploadError) uploadError.classList.add('hidden');
                if (uploadSuccess) uploadSuccess.classList.add('hidden');
                const uploadForm = document.getElementById('uploadForm');
                if (uploadForm) uploadForm.reset();
            }
        });
    }

    // Document Details Modal functionality
    const documentDetailsModal = document.getElementById('documentDetailsModal');
    const documentDetailsTitle = document.getElementById('documentDetailsTitle');
    const documentDetailsContent = document.getElementById('documentDetailsContent');

    // Make openDocumentDetails globally available
    window.openDocumentDetails = async function(documentId) {
        const token = localStorage.getItem('access_token');

        if (!token) {
            alert('Please log in to view document details.');
            return;
        }

        if (documentDetailsTitle) documentDetailsTitle.textContent = 'Loading Document...';
        if (documentDetailsContent) documentDetailsContent.innerHTML = '<p>Fetching details...</p>';
        if (documentDetailsModal) {
            documentDetailsModal.classList.remove('hidden');
            documentDetailsModal.classList.add('flex');
        }

        try {
            const res = await fetch(`/api/v1/documents/${documentId}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (res.ok) {
                const doc = await res.json();
                if (documentDetailsTitle) documentDetailsTitle.textContent = doc.filename;
                if (documentDetailsContent) {
                    documentDetailsContent.innerHTML = `
                        <h3 class="text-xl font-semibold mb-2">Extracted Text:</h3>
                        <p class="mb-4">${doc.extracted_text}</p>
                        <h3 class="text-xl font-semibold mb-2">Analysis Result:</h3>
                        <p>${doc.analysis_result}</p>
                        <div class="mt-6">
                            <button id="chatAboutDocumentButton" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                                Chat About This Document
                            </button>
                        </div>
                    `;
                    
                    // Setup chat button
                    const chatButton = document.getElementById('chatAboutDocumentButton');
                    if (chatButton) {
                        chatButton.addEventListener('click', () => {
                            const chatDocumentIdInput = document.getElementById('chatDocumentId');
                            if (chatDocumentIdInput) {
                                chatDocumentIdInput.value = doc.id;
                            }
                            window.location.href = `/chat?document_id=${doc.id}`;
                        });
                    }
                }
                // Store document ID for chat
                if (documentDetailsModal) documentDetailsModal.dataset.currentDocumentId = doc.id;
            } else if (res.status === 401) {
                await window.authUtils.verifyToken();
                if (documentDetailsContent) {
                    documentDetailsContent.innerHTML = '<p class="text-red-500">Your session has expired or you are not authorized. Please log in again.</p>';
                }
            } else {
                const errorData = await res.json();
                if (documentDetailsContent) {
                    documentDetailsContent.innerHTML = `<p class="text-red-500">Error: ${errorData.detail || 'Could not fetch document details.'}</p>`;
                }
            }
        } catch (err) {
            if (documentDetailsContent) {
                documentDetailsContent.innerHTML = '<p class="text-red-500">Could not connect to the server to fetch document details.</p>';
            }
            console.error('Error fetching document details:', err);
        }
    };

    // Make deleteDocument globally available
    window.deleteDocument = function(documentId, filename) {
        const deleteModal = document.getElementById('deleteConfirmationModal');
        const deleteMessage = document.getElementById('deleteConfirmationMessage');
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        const cancelDeleteBtn = document.getElementById('cancelDelete');

        if (deleteModal && deleteMessage && confirmDeleteBtn && cancelDeleteBtn) {
            // Update the message
            deleteMessage.textContent = `Are you sure you want to delete "${filename}"? This action cannot be undone.`;
            
            // Show the modal
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');

            // Handle confirm button
            const handleConfirm = async () => {
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
                await performDeleteDocument(documentId, filename);
                confirmDeleteBtn.removeEventListener('click', handleConfirm);
                cancelDeleteBtn.removeEventListener('click', handleCancel);
            };

            // Handle cancel button
            const handleCancel = () => {
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
                confirmDeleteBtn.removeEventListener('click', handleConfirm);
                cancelDeleteBtn.removeEventListener('click', handleCancel);
            };

            confirmDeleteBtn.addEventListener('click', handleConfirm);
            cancelDeleteBtn.addEventListener('click', handleCancel);
        } else {
            // Fallback to browser confirm if modal elements not found
            const confirmDelete = confirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`);
            if (confirmDelete) {
                performDeleteDocument(documentId, filename);
            }
        }
    };

    async function performDeleteDocument(documentId, filename) {
        const token = localStorage.getItem('access_token');

        if (!token) {
            alert('Please log in to delete documents.');
            return;
        }

        // Show loading state
        const documentElement = document.querySelector(`li[data-document-id="${documentId}"]`);
        if (documentElement) {
            documentElement.style.opacity = '0.5';
            documentElement.style.pointerEvents = 'none';
        }

        try {
            const res = await fetch(`/api/v1/documents/${documentId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (res.ok) {
                // Show success message
                showNotification(`Document "${filename}" has been deleted successfully.`, 'success');
                // Refresh the documents list
                await fetchDocuments();
            } else if (res.status === 401) {
                await window.authUtils.verifyToken();
                showNotification('Your session has expired. Please log in again.', 'error');
            } else if (res.status === 404) {
                showNotification('Document not found. It may have already been deleted.', 'warning');
                // Refresh the list anyway
                await fetchDocuments();
            } else {
                const errorData = await res.json();
                showNotification(`Error deleting document: ${errorData.detail || 'Unknown error'}`, 'error');
            }
        } catch (err) {
            showNotification('Could not connect to the server to delete the document.', 'error');
            console.error('Error deleting document:', err);
        } finally {
            // Restore element state if it still exists
            if (documentElement) {
                documentElement.style.opacity = '1';
                documentElement.style.pointerEvents = 'auto';
            }
        }
    }

    // Simple notification system
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 transform translate-x-full`;
        
        // Set colors based on type
        switch (type) {
            case 'success':
                notification.className += ' bg-green-500 text-white';
                break;
            case 'error':
                notification.className += ' bg-red-500 text-white';
                break;
            case 'warning':
                notification.className += ' bg-yellow-500 text-black';
                break;
            default:
                notification.className += ' bg-blue-500 text-white';
        }
        
        notification.innerHTML = `
            <div class="flex items-center justify-between">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-xl leading-none">&times;</button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 5000);
    }

    documentsListContainer.addEventListener('click', async (e) => {
        // Remove the old click handler since we're now using onclick attributes
        // This prevents conflicts with the new button-based approach
    });
});
</script>
{% endblock %}