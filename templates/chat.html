{% extends "base.html" %}

{% block title %}Chat - NyayEase{% endblock %}

{% block extra_head %}
<style>
    .chat-container { height: calc(100vh - 200px); }
    .message-bubble { max-width: 80%; }
    .user-message { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        color: white;
    }
    .ai-message { 
        background: #f8fafc; 
        border: 1px solid #e2e8f0;
    }
    .document-context-banner {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-indigo-600 text-white p-6">
            <h1 class="text-2xl font-bold">Legal AI Assistant</h1>
            <p class="text-indigo-200">Ask me anything about Indian law, your rights, or legal procedures</p>
        </div>
        
        <!-- Document Context Banner (hidden by default) -->
        <div id="documentContextBanner" class="document-context-banner hidden">
            <div>
                <span class="font-semibold">📄 Document Context Active:</span>
                <span id="documentContextName">Loading...</span>
            </div>
            <button id="clearDocumentContext" class="text-white hover:text-gray-200 text-sm underline">
                Clear Context
            </button>
        </div>
        
        <div id="chatMessages" class="chat-container overflow-y-auto p-6 space-y-4">
            <div class="flex">
                <div class="message-bubble ai-message p-4 rounded-lg">
                    <p class="font-semibold text-indigo-600 mb-2">🤖 NyayEase Assistant</p>
                    <p>Hello! I'm here to help you understand Indian law. You can:</p>
                    <ul class="list-disc ml-5 mt-2 space-y-1">
                        <li>Ask about constitutional articles (e.g., "What is Article 21?")</li>
                        <li>Get help with legal scenarios (e.g., "My landlord is threatening eviction")</li>
                        <li>Upload legal documents for explanation</li>
                        <li>Ask in Hindi or Marathi too!</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="border-t p-6">
            <div class="flex space-x-4">
                <div class="flex-1">
                    <textarea 
                        id="messageInput" 
                        placeholder="Type your legal question here..." 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"
                        rows="2"
                    ></textarea>
                </div>
                <div class="flex flex-col space-y-2">
                    <button 
                        id="sendButton" 
                        class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition font-semibold"
                    >
                        Send
                    </button>
                    <select id="languageSelect" class="text-sm border border-gray-300 rounded px-2 py-1">
                        <option value="en">English</option>
                        <option value="hi">हिंदी</option>
                        <option value="mr">मराठी</option>
                    </select>
                </div>
            </div>
            
            <div class="mt-4 flex flex-wrap gap-2">
                <button class="quick-action bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm" data-query="What is Article 21?">
                    Article 21
                </button>
                <button class="quick-action bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm" data-query="Landlord eviction rights">
                    Tenant Rights
                </button>
                <button class="quick-action bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm" data-query="Police arrest procedure">
                    Arrest Rights
                </button>
                <button class="quick-action bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm" data-query="Women harassment law">
                    Harassment Law
                </button>
                <!-- Document-specific quick actions (hidden by default) -->
                <button id="documentSummaryAction" class="quick-action bg-green-100 hover:bg-green-200 px-3 py-1 rounded text-sm hidden" data-query="What is this document about?">
                    Document Summary
                </button>
                <button id="documentActionAction" class="quick-action bg-green-100 hover:bg-green-200 px-3 py-1 rounded text-sm hidden" data-query="What action do I need to take based on this document?">
                    Required Actions
                </button>
                <button id="documentDeadlineAction" class="quick-action bg-green-100 hover:bg-green-200 px-3 py-1 rounded text-sm hidden" data-query="Are there any important dates or deadlines in this document?">
                    Important Dates
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const chatMessages = document.getElementById('chatMessages');
    const languageSelect = document.getElementById('languageSelect');
    const quickActions = document.querySelectorAll('.quick-action');
    const documentContextBanner = document.getElementById('documentContextBanner');
    const documentContextName = document.getElementById('documentContextName');
    const clearDocumentContext = document.getElementById('clearDocumentContext');
    
    // Document-specific elements
    const documentSummaryAction = document.getElementById('documentSummaryAction');
    const documentActionAction = document.getElementById('documentActionAction');
    const documentDeadlineAction = document.getElementById('documentDeadlineAction');
    
    let currentDocumentId = null;
    let currentDocumentName = null;
    
    // Extract document_id from URL parameters
    function getDocumentIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('document_id');
    }
    
    // Load document context if document_id is in URL
    async function loadDocumentContext() {
        const documentId = getDocumentIdFromURL();
        if (!documentId) return;
        
        const token = localStorage.getItem('access_token');
        if (!token) {
            console.warn('No token found, cannot load document context');
            return;
        }
        
        try {
            const res = await fetch(`/api/v1/documents/${documentId}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });
            
            if (res.ok) {
                const document = await res.json();
                currentDocumentId = documentId;
                currentDocumentName = document.filename;
                
                // Show document context banner
                documentContextName.textContent = document.filename;
                documentContextBanner.classList.remove('hidden');
                
                // Show document-specific quick actions
                documentSummaryAction.classList.remove('hidden');
                documentActionAction.classList.remove('hidden');
                documentDeadlineAction.classList.remove('hidden');
                
                // Add initial message about document context
                addMessageToChat(`📄 Document context loaded: "${document.filename}". You can now ask questions about this specific document!`, 'ai');
                
            } else if (res.status === 401) {
                await window.authUtils.verifyToken();
                console.warn('Authentication failed while loading document context');
            } else {
                console.error('Failed to load document context:', res.status);
            }
        } catch (err) {
            console.error('Error loading document context:', err);
        }
    }
    
    // Clear document context
    function clearDocumentContextHandler() {
        currentDocumentId = null;
        currentDocumentName = null;
        documentContextBanner.classList.add('hidden');
        
        // Hide document-specific quick actions
        documentSummaryAction.classList.add('hidden');
        documentActionAction.classList.add('hidden');
        documentDeadlineAction.classList.add('hidden');
        
        // Update URL to remove document_id parameter
        const url = new URL(window.location);
        url.searchParams.delete('document_id');
        window.history.replaceState({}, '', url);
        
        addMessageToChat("Document context cleared. You can now ask general legal questions.", 'ai');
    }
    
    // Quick action handlers
    quickActions.forEach(button => {
        button.addEventListener('click', () => {
            messageInput.value = button.dataset.query;
            sendMessage();
        });
    });
    
    // Clear document context handler
    if (clearDocumentContext) {
        clearDocumentContext.addEventListener('click', clearDocumentContextHandler);
    }
    
    async function sendMessage() {
        const message = messageInput.value.trim();
        const language = languageSelect.value;
        
        if (!message) return;
        
        // Add user message
        addMessageToChat(message, 'user');
        messageInput.value = '';
        
        // Show typing indicator
        showTypingIndicator();
        
        try {
            const token = localStorage.getItem("access_token");
            
            // Prepare request body
            const requestBody = {
                query: message,
                language: language,
                query_type: "general"
            };
            
            // Add document_id if we have document context
            if (currentDocumentId) {
                requestBody.document_id = parseInt(currentDocumentId);
            }
            
            const res = await fetch("/api/v1/query/ask", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    ...(token ? { "Authorization": "Bearer " + token } : {})
                },
                body: JSON.stringify(requestBody)
            });
            
            const data = await res.json();
            hideTypingIndicator();
            
            if (res.ok) {
                addMessageToChat(data.response, 'ai');
            } else if (res.status === 401) {
                // Token might be invalid, try to refresh auth state
                await window.authUtils.verifyToken();
                addMessageToChat("⚠️ Authentication issue detected. Your query was processed, but please log in to save your history.", 'ai');
            } else {
                addMessageToChat("⚠️ Error: " + (data.detail || "Could not process query."), 'ai');
            }
        } catch (err) {
            hideTypingIndicator();
            addMessageToChat("⚠️ Error: Could not connect to server.", 'ai');
            console.error(err);
        }
    }
    
    // Make addMessageToChat globally available for auth system
    window.addMessageToChat = function(message, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex ' + (sender === 'user' ? 'justify-end' : '');
        
        const bubbleClass = sender === 'user' ? 'user-message' : 'ai-message';
        const senderName = sender === 'user' ? '👤 You' : '🤖 NyayEase';
        const messageContent = sender === 'ai' ? marked.parse(message) : `<p>${message}</p>`;

        messageDiv.innerHTML = `
            <div class="message-bubble ${bubbleClass} p-4 rounded-lg">
                <p class="font-semibold mb-2 ${sender === 'user' ? 'text-white' : 'text-indigo-600'}">${senderName}</p>
                <div class="prose">${messageContent}</div>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'flex';
        typingDiv.innerHTML = `
            <div class="message-bubble ai-message p-4 rounded-lg">
                <p class="font-semibold text-indigo-600 mb-2">🤖 NyayEase</p>
                <p class="text-gray-500">Thinking...</p>
            </div>
        `;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }
    
    // Event listeners
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Initialize document context on page load
    loadDocumentContext();
});
</script>
{% endblock %}